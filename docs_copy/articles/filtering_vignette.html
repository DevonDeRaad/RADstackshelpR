<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>filtering_vignette • RADstackshelpR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="filtering_vignette">
<meta property="og:description" content="RADstackshelpR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">RADstackshelpR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/filtering_vignette.html">filtering_vignette</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>filtering_vignette</h1>
            
      
      
      <div class="hidden name"><code>filtering_vignette.Rmd</code></div>

    </div>

    
    
<div class="sourceCode"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RADstackshelpR</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/knausb/vcfR">vcfR</a></span><span class="op">)</span>
<span class="co">#&gt; Warning: package 'vcfR' was built under R version 3.5.2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;    *****       ***   vcfR   ***       *****</span>
<span class="co">#&gt;    This is vcfR 1.9.0 </span>
<span class="co">#&gt;      browseVignettes('vcfR') # Documentation</span>
<span class="co">#&gt;      citation('vcfR') # Citation</span>
<span class="co">#&gt;    *****       *****      *****       *****</span></pre></div>
<p>Read in your unfiltered vcf file</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">#read in vcf as vcfR</span>
<span class="va">vcfR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/vcfR/man/io_vcfR.html">read.vcfR</a></span><span class="op">(</span><span class="st">"~/Desktop/aph.data/populations.snps.vcf"</span><span class="op">)</span></pre></div>
<div class="sourceCode"><pre class="downlit">
<span class="co">#rename mislabeled sample</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">vcfR</span><span class="op">@</span><span class="va">gt</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">vcfR</span><span class="op">@</span><span class="va">gt</span><span class="op">)</span> <span class="op">==</span> <span class="st">"A_californica_334171"</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"A_woodhouseii_334171"</span>

<span class="co">#generate popmap file. Two column popmap with the same format as stacks, and the columns must be named 'id' and 'pop'</span>
<span class="va">popmap</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">vcfR</span><span class="op">@</span><span class="va">gt</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">vcfR</span><span class="op">@</span><span class="va">gt</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,pop<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">vcfR</span><span class="op">@</span><span class="va">gt</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">vcfR</span><span class="op">@</span><span class="va">gt</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, <span class="fl">3</span>,<span class="fl">11</span><span class="op">)</span><span class="op">)</span>

<span class="co">### check the metadata present in your vcf</span>
<span class="va">vcfR</span>
<span class="co">#&gt; ***** Object of Class vcfR *****</span>
<span class="co">#&gt; 115 samples</span>
<span class="co">#&gt; 87 CHROMs</span>
<span class="co">#&gt; 210,336 variants</span>
<span class="co">#&gt; Object size: 685.5 Mb</span>
<span class="co">#&gt; 57.1 percent missing data</span>
<span class="co">#&gt; *****        *****         *****</span>
<span class="va">vcfR</span><span class="op">@</span><span class="va">gt</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>
<span class="co">#&gt;       FORMAT           A_californica_333849                </span>
<span class="co">#&gt;  [1,] "GT:DP:AD:GQ:GL" NA                                  </span>
<span class="co">#&gt;  [2,] "GT:DP:AD:GQ:GL" NA                                  </span>
<span class="co">#&gt;  [3,] "GT:DP:AD:GQ:GL" NA                                  </span>
<span class="co">#&gt;  [4,] "GT:DP:AD:GQ:GL" "1/1:67:0,67:40:-256.40,-21.43,0.00"</span>
<span class="co">#&gt;  [5,] "GT:DP:AD:GQ:GL" "1/1:67:0,67:40:-226.28,-20.45,0.00"</span>
<span class="co">#&gt;  [6,] "GT:DP:AD:GQ:GL" "0/0:2:2,0:32:-0.00,-2.62,-6.23"    </span>
<span class="co">#&gt;  [7,] "GT:DP:AD:GQ:GL" "1/1:2:0,2:27:-4.96,-2.15,-0.00"    </span>
<span class="co">#&gt;  [8,] "GT:DP:AD:GQ:GL" "0/0:2:2,0:31:-0.00,-2.51,-5.68"    </span>
<span class="co">#&gt;  [9,] "GT:DP:AD:GQ:GL" NA                                  </span>
<span class="co">#&gt; [10,] "GT:DP:AD:GQ:GL" NA</span></pre></div>
<p>This peek into the genotype matrix of the vcfR object (which is accessed via <a href="mailto:vcfR@gt">vcfR@gt</a>) shows the matrix with # of rows = # of SNPs, and # of columns = # of samples + 1 (first column describing format). Going forward, each cell in this matrix will be referred to as a genotype, each row will be referred to as a SNP, and each column will be referred to as a sample.</p>
<div id="step-1-implement-quality-filters-that-dont-involve-missing-data--removing-low-data-samplessnps-will-alter-percentagequantile-based-cutoffs-so-we-wait-to-implement-those-until-after-deciding-on-our-final-set-of-samples-for-downstream-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#step-1-implement-quality-filters-that-dont-involve-missing-data--removing-low-data-samplessnps-will-alter-percentagequantile-based-cutoffs-so-we-wait-to-implement-those-until-after-deciding-on-our-final-set-of-samples-for-downstream-analysis" class="anchor"></a>step 1: Implement quality filters that don't involve missing data. Removing low data samples/SNPs will alter percentage/quantile based cutoffs, so we wait to implement those until after deciding on our final set of samples for downstream analysis</h1>
<p>Note:If you have a very large vcf output file that you would like to work with in Rstudio, you could implement some percentage based filters (e.g. remove all SNPs above 50% missing data) via vcftools to reduce your filesize before starting to filter in R. Just be aware that once you drop low data samples, your previously enforced (per SNP or locus) missing data % will no longer be exact.</p>
<p>Jon Puritz has an excellent filtering tutorial that is focused specifically on filtering RADseq data: <a href="https://www.ddocent.com/filtering/" class="uri">https://www.ddocent.com/filtering/</a> Some of these RAD specific filters can't be applied to a vcf output by stacks, which doesn't retain metadata like mapping quality and strand, but we can follow these guidelines for hard filtering (he suggests minimum depth=3, gq =30), and can implement suggested filters like allele balance and max depth, here in R. Our first function is a hard filter that allows you to set minimum depth and genotype quality thresholds to retain a called genotype.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">#hard filter to minimum depth of 5, and minimum genotype quality of 30</span>
<span class="va">vcfR</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/hard.filter.vcf.html">hard.filter.vcf</a></span><span class="op">(</span>vcfR<span class="op">=</span><span class="va">vcfR</span>, depth <span class="op">=</span> <span class="fl">5</span>, gq <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>
<span class="co">#&gt; [1] "32.92% of genotypes fall below a read depth of 5 and were converted to NA"</span>
<span class="co">#&gt; [1] "2.01% of genotypes fall below a genotype quality of 30 and were converted to NA"</span></pre></div>
<p>From Puritz SNP filtering tutorial "Allele balance: a number between 0 and 1 representing the ratio of reads showing the reference allele to all reads, considering only reads from individuals called as heterozygous, we expect that the allele balance in our data (for real loci) should be close to 0.5" This function filters for allele balance, converting heterozygous genotypes with an allele balance &lt; .25 or &gt; .75 to 'NA'.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">#execute allele balance filter</span>
<span class="va">vcfR</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/filter.allele.balance.html">filter.allele.balance</a></span><span class="op">(</span><span class="va">vcfR</span><span class="op">)</span>
<span class="co">#&gt; [1] "7.56% of het genotypes (0.39% of all genotypes) fall outside of .25 - .75 allele balance and were converted to NA"</span></pre></div>
<p>This is a max depth filter (super high depth loci are likely multiple loci stuck together into a single paralogous locus). We want to remove the upper tail of the distribution which is likely full of paralogues, without tossing too much of our overall data. We run this function first without specifying 'maxdepth' to visualize the distribution, and then set the cutoff to filter our vcf by specifying a numeric value to 'maxdepth'. Note: we want to apply this 'per SNP' rather than 'per genotype' otherwise we will simply be removing most of the genotypes from our deepest sequenced samples (because sequencing depth is so variable between samples)</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">#visualize and pick appropriate max depth cutoff</span>
<span class="fu"><a href="../reference/max_depth.html">max_depth</a></span><span class="op">(</span><span class="va">vcfR</span><span class="op">)</span></pre></div>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-7-1.png" width="768" style="display: block; margin: auto;"></p>
<pre><code><a href="https://rdrr.io/r/graphics/par.html">#&gt; [1] "dashed line indicates a mean depth across all SNPs of 46.7"
par(mfrow=c(1,1))
#filter vcf by the max depth cutoff you chose
vcfR&lt;-max_depth(vcfR, maxdepth = 100)</a></code></pre>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-7-2.png" width="768" style="display: block; margin: auto;"></p>
<pre><code>#&gt; [1] "12.85% of SNPs were above a mean depth of 100 and were removed from the vcf"</code></pre>
<p>Note: It may be a good idea to additionally filter out SNPs that are significantly out of HWE if you have a really good idea of what the population structure in your sample looks like and good sample sizes in each pop. For this dataset, which is highly structured (many isolated island pops) with species boundaries that are in flux, I am not going to use a HWE filter, because I don't feel comfortable confidently identifying populations in which we can expect HWE.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">#check vcfR to see how many SNPs we have left</span>
<span class="va">vcfR</span>
<span class="co">#&gt; ***** Object of Class vcfR *****</span>
<span class="co">#&gt; 115 samples</span>
<span class="co">#&gt; 78 CHROMs</span>
<span class="co">#&gt; 183,293 variants</span>
<span class="co">#&gt; Object size: 408 Mb</span>
<span class="co">#&gt; 79.79 percent missing data</span>
<span class="co">#&gt; *****        *****         *****</span></pre></div>
</div>
<div id="step-2-visualize-missing-data-by-sample--check-out-the-visualizations-and-make-decision-on-which-samples-to-keep-for-downstream-analysis-" class="section level1">
<h1 class="hasAnchor">
<a href="#step-2-visualize-missing-data-by-sample--check-out-the-visualizations-and-make-decision-on-which-samples-to-keep-for-downstream-analysis-" class="anchor"></a>Step 2: visualize missing data by sample. Check out the visualizations and make decision on which samples to keep for downstream analysis.</h1>
<p>Determining which samples to retain is highly project specific, and is contingent on your sampling, your taxa, the sequencing results, etc. It is also wise to take missing data into account by population. Often we don't know a-priori what our populations will look like, but in general we want to avoid making inferences about populations if they have consistently less information than the rest of our dataset. On the flip side of that coin, you may have designed a project to get information about a rare sample/population that lacks existing genetic sampling, and therefore must retain specific samples despite low sequencing and high missing data. This is a reality, and simply needs to be addressed carefully.</p>
<p>We run this function first without specifying 'cutoff', to visualize the distribution of missing data per sample. Then we run the function with a set cutoff for the maximum amount of missing data allowed to retain a sample, which will remove samples falling below our cutoff from the vcf.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">#run function to visualize samples</span>
<span class="va">miss</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/missing.by.sample.html">missing.by.sample</a></span><span class="op">(</span>vcfR<span class="op">=</span><span class="va">vcfR</span>, popmap <span class="op">=</span> <span class="va">popmap</span><span class="op">)</span>
<span class="co">#&gt; `stat_bindot()` using `bins = 30`. Pick better value with `binwidth`.</span>
<span class="co">#&gt; `stat_bindot()` using `bins = 30`. Pick better value with `binwidth`.</span></pre></div>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-9-1.png" width="768" style="display: block; margin: auto;"><img src="filtering_vignette_files/figure-html/unnamed-chunk-9-2.png" width="768" style="display: block; margin: auto;"><img src="filtering_vignette_files/figure-html/unnamed-chunk-9-3.png" width="768" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit">

<span class="co">#run function to drop samples above the threshold we want from the vcf</span>
<span class="va">vcfR</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/missing.by.sample.html">missing.by.sample</a></span><span class="op">(</span>vcfR<span class="op">=</span><span class="va">vcfR</span>, cutoff <span class="op">=</span> <span class="fl">.91</span><span class="op">)</span></pre></div>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-9-4.png" width="768" style="display: block; margin: auto;"></p>
<pre><code>#&gt; [1] "20 samples are above a 0.91 missing data cutoff, and were removed from VCF"

#subset popmap to only include retained individuals
popmap&lt;-popmap[popmap$id %in% colnames(vcfR@gt),]

#reorder vcf to group by species
vcfR@gt&lt;-vcfR@gt[,c(1:20,22:57,21,58:95)]

#alternatively, you can drop individuals from vcfR manually using the following syntax, if a strict cutoff doesn't work for your dataset
#vcfR@gt &lt;- vcfR@gt[,colnames(vcfR@gt) != "E_trichroa_4702" &amp; colnames(vcfR@gt) != "E_trichroa_27882"]</code></pre>
</div>
<div id="step-3-set-the-arbitrary-missing-data-cutoff" class="section level1">
<h1 class="hasAnchor">
<a href="#step-3-set-the-arbitrary-missing-data-cutoff" class="anchor"></a>Step 3: Set the arbitrary missing data cutoff</h1>
<p>We can visualize the effect that typical missing data cutoffs will have on both the number of SNPs retained and the total missing data in our entire dataset. We want to choose a cutoff that minimizes the overall missing data in the dataset, while maximizing the total number of loci retained. Note: This will also depend on the samples that we decided to include above. A good rule of thumb is that samples shouldn't be above 50% missing data after applying this cutoff. So if we are retaining low data samples out of necessity or project design, we may have to set a more stringent cutoff at the expense of total SNPs retained for downstream analyses.</p>
<p>We run this function without setting cutoff to visualize the distribution of missing data across potential filtering schemes, and then set the cutoff to remove SNPs falling below a given proportion (0-1) of missing data.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">#visualize missing data by SNP and the effect of various cutoffs on the missingness of each sample</span>
<span class="fu"><a href="../reference/missing.by.snp.html">missing.by.snp</a></span><span class="op">(</span><span class="va">vcfR</span><span class="op">)</span>
<span class="co">#&gt; Picking joint bandwidth of 0.0655</span></pre></div>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-10-1.png" width="768" style="display: block; margin: auto;"><img src="filtering_vignette_files/figure-html/unnamed-chunk-10-2.png" width="768" style="display: block; margin: auto;"></p>
<pre><code>#&gt;    filt missingness snps.retained
#&gt; 1  0.30  0.32041725         53623
#&gt; 2  0.50  0.21129607         38822
#&gt; 3  0.60  0.15913715         31940
#&gt; 4  0.65  0.13518493         28727
#&gt; 5  0.70  0.11760089         26283
#&gt; 6  0.75  0.09582935         23118
#&gt; 7  0.80  0.07498840         19853
#&gt; 8  0.85  0.05870236         17090
#&gt; 9  0.90  0.03948609         13333
#&gt; 10 0.95  0.01901272          8294
#&gt; 11 1.00  0.00000000          1809
#choose a value that retains an acceptable amount of missing data in each sample, and maximizes SNPs retained while minimizing overall missing data, and filter vcf
vcfR&lt;-missing.by.snp(vcfR, cutoff = .85)</code></pre>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-10-3.png" width="768" style="display: block; margin: auto;"></p>
<pre><code>#&gt; [1] "90.68% of SNPs fell below a completeness cutoff of 0.85 and were removed from the VCF"</code></pre>
</div>
<div id="step-4-investigate-the-effect-of-a-minor-allele-frequency-cutoff-on-our-downstream-inferences-" class="section level1">
<h1 class="hasAnchor">
<a href="#step-4-investigate-the-effect-of-a-minor-allele-frequency-cutoff-on-our-downstream-inferences-" class="anchor"></a>Step 4: investigate the effect of a minor allele frequency cutoff on our downstream inferences.</h1>
<p>MAF cutoffs can be helpful in removing spurious and uninformative loci from the dataset, but also have the potential to bias downstream inferences. Linck and Battey (2019) have an excellent paper on just this topic. From the paper-</p>
<p>"We recommend researchers using model‐based programs to describe population structure observe the following best practices: (a) duplicate analyses with nonparametric methods suchas PCA and DAPC with cross validation (b) exclude singletons (c) compare alignments with multiple assembly parameters When seeking to exclude only singletons in alignments with missing data (a ubiquitous problem for reduced‐representation library preparation methods), it is preferable to filter by the count (rather than frequency) of the minor allele, because variation in the amount of missing data across an alignment will cause a static frequency cutoff to remove different SFS classes at different sites""</p>
<p>Our package contains a convenient wrapper function that streamlines the investigation of different MAF cutoffs. Warning: this is a heavy function if it is run without the 'min.mac' option. It is converting the entire vcf into a genlight and running 6 unique dapc iterations, which will take a minute for larger datasets. If you set 'min.mac' it will just filter your dataset, and should run quickly.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">#use min.mac() to investigate the effect of multiple cutoffs</span>
<span class="fu"><a href="../reference/min_mac.html">min_mac</a></span><span class="op">(</span>vcfR <span class="op">=</span> <span class="va">vcfR</span>, popmap <span class="op">=</span> <span class="va">popmap</span><span class="op">)</span></pre></div>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-11-1.png" width="768" style="display: block; margin: auto;"></p>
<pre><code>#&gt; [1] "for 1 minimum MAC cutoff, compare k means clustering to popmap assignment"
#&gt;            
#&gt;              1  2  3  4  5
#&gt;   californi  0 31  0  0  0
#&gt;   coerulesc  6  0  0  0  0
#&gt;   insularis  0  0  0  0  8
#&gt;   sumichras  0  0  0 10  0
#&gt;   woodhouse  0  0 39  0  0</code></pre>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-11-2.png" width="768" style="display: block; margin: auto;"></p>
<pre><code>#&gt; [1] "DAPC with min. MAC 1 and 16208 total SNPs, complete"
#&gt; [1] "for 2 minimum MAC cutoff, compare k means clustering to popmap assignment"
#&gt;            
#&gt;              1  2  3  4  5
#&gt;   californi  0  0  0  0 31
#&gt;   coerulesc  0  6  0  0  0
#&gt;   insularis  8  0  0  0  0
#&gt;   sumichras  0  0  0 10  0
#&gt;   woodhouse  0  0 39  0  0</code></pre>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-11-3.png" width="768" style="display: block; margin: auto;"></p>
<pre><code>#&gt; [1] "DAPC with min. MAC 2 and 11188 total SNPs, complete"
#&gt; [1] "for 3 minimum MAC cutoff, compare k means clustering to popmap assignment"
#&gt;            
#&gt;              1  2  3  4  5
#&gt;   californi  0  0  0  0 31
#&gt;   coerulesc  0  6  0  0  0
#&gt;   insularis  0  0  0  8  0
#&gt;   sumichras  0  0 10  0  0
#&gt;   woodhouse 39  0  0  0  0</code></pre>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-11-4.png" width="768" style="display: block; margin: auto;"></p>
<pre><code>#&gt; [1] "DAPC with min. MAC 3 and 8531 total SNPs, complete"
#&gt; [1] "for 4 minimum MAC cutoff, compare k means clustering to popmap assignment"
#&gt;            
#&gt;              1  2  3  4  5
#&gt;   californi  0  0 31  0  0
#&gt;   coerulesc  0  6  0  0  0
#&gt;   insularis  8  0  0  0  0
#&gt;   sumichras  0  0  0 10  0
#&gt;   woodhouse  0  0  0  0 39</code></pre>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-11-5.png" width="768" style="display: block; margin: auto;"></p>
<pre><code>#&gt; [1] "DAPC with min. MAC 4 and 7052 total SNPs, complete"
#&gt; [1] "for 5 minimum MAC cutoff, compare k means clustering to popmap assignment"
#&gt;            
#&gt;              1  2  3  4  5
#&gt;   californi  0 31  0  0  0
#&gt;   coerulesc  0  0  0  0  6
#&gt;   insularis  0  0  0  8  0
#&gt;   sumichras 10  0  0  0  0
#&gt;   woodhouse  0  0 39  0  0</code></pre>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-11-6.png" width="768" style="display: block; margin: auto;"></p>
<pre><code>#&gt; [1] "DAPC with min. MAC 5 and 6023 total SNPs, complete"
#&gt; [1] "for 10 minimum MAC cutoff, compare k means clustering to popmap assignment"
#&gt;            
#&gt;              1  2  3  4  5
#&gt;   californi  0  0  0 31  0
#&gt;   coerulesc  0  0  6  0  0
#&gt;   insularis  8  0  0  0  0
#&gt;   sumichras  0 10  0  0  0
#&gt;   woodhouse  0  0  0  0 39</code></pre>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-11-7.png" width="768" style="display: block; margin: auto;"></p>
<pre><code>#&gt; [1] "DAPC with min. MAC 10 and 3555 total SNPs, complete"

#based on these visualizations, I will remove singletons from the dataset, as it doesn't affect group inference
vcfR&lt;-min_mac(vcfR, min.mac = 2)</code></pre>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-11-8.png" width="768" style="display: block; margin: auto;"></p>
<pre><code>#&gt; [1] "34.53% of SNPs fell below a minor allele count of 2 and were removed from the VCF"</code></pre>
<p>check once more to see how many SNPs and individuals remain compared to our original, unfiltered vcf</p>
<div class="sourceCode"><pre class="downlit">
<span class="va">vcfR</span>
<span class="co">#&gt; ***** Object of Class vcfR *****</span>
<span class="co">#&gt; 94 samples</span>
<span class="co">#&gt; 35 CHROMs</span>
<span class="co">#&gt; 11,188 variants</span>
<span class="co">#&gt; Object size: 77.1 Mb</span>
<span class="co">#&gt; 5.896 percent missing data</span>
<span class="co">#&gt; *****        *****         *****</span>

<span class="co">#plot depth per snp and per sample</span>
<span class="va">dp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/vcfR/man/extract_gt.html">extract.gt</a></span><span class="op">(</span><span class="va">vcfR</span>, element <span class="op">=</span> <span class="st">"DP"</span>, as.numeric<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/vcfR/man/heatmap_bp.html">heatmap.bp</a></span><span class="op">(</span><span class="va">dp</span>, rlabels <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></pre></div>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-12-1.png" width="768" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit">

<span class="co">#plot genotype quality per snp and per sample</span>
<span class="va">gq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/vcfR/man/extract_gt.html">extract.gt</a></span><span class="op">(</span><span class="va">vcfR</span>, element <span class="op">=</span> <span class="st">"GQ"</span>, as.numeric<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/vcfR/man/heatmap_bp.html">heatmap.bp</a></span><span class="op">(</span><span class="va">gq</span>, rlabels <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></pre></div>
<p><img src="filtering_vignette_files/figure-html/unnamed-chunk-12-2.png" width="768" style="display: block; margin: auto;"></p>
<p>We can use the convenient function 'write.vcf' from vcfR to export our filtered vcf file for downstream analyses</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">#write.vcf(vcfR, "~/Desktop/aph.data/filtered.vcf.gz")</span></pre></div>
<p>If you need physically unlinked loci (which is a requirement of some programs, e.g. structure) this filtering step should always be done last, because it is not quality aware. Introducing a quality-blind linkage filter before doing the quality based filtering shown here would potentially remove quality SNPs while leaving us with only the low quality SNPs in a locus or genomic region. If filtering for linkage is needed, it can be done on our output vcf file with a simple one-liner via vcftools (set thin to whatever bp distance you assume linakge decays at in your study organism) vcftools --vcf vcf.vcf --thin 10000 --recode --out vcf</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Devon DeRaad.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
